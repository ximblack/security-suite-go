<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Suite - Production Control Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Production-Ready Styles */
        body { 
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif; 
            background-color: #0f172a; 
            color: #e2e8f0;
        }
        .critical { background-color: #7f1d1d; color: #fecaca; }
        .high { background-color: #7c2d12; color: #fed7aa; }
        .medium { background-color: #713f12; color: #fef08a; }
        .info { background-color: #1e3a8a; color: #dbeafe; }
        .terminal-output {
            font-family: 'Courier New', 'Consolas', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.4;
            background: #000;
            color: #0f0;
        }
        .terminal-input {
            font-family: 'Courier New', 'Consolas', monospace;
            background: #000;
            color: #0f0;
            caret-color: #0f0; /* Green cursor */
            border: 1px solid #0f0;
            /* Ensures no focus outline from Tailwind interferes */
            outline: none !important; 
        }
        /* Custom Blink Cursor for production-feel */
        .blink-cursor {
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-online { background-color: #10b981; }
        .status-offline { background-color: #ef4444; }
        .status-warning { background-color: #f59e0b; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8 border-b border-gray-700 pb-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <svg class="w-10 h-10 mr-3 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.332 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <div>
                        <h1 class="text-3xl font-extrabold text-white">Security Suite</h1>
                        <p class="text-sm text-gray-400">Production Threat Detection & Response Platform v2.0</p>
                    </div>
                </div>
                
                <div id="system-status" class="text-right">
                    <div class="text-lg font-semibold text-gray-300">
                        <span class="status-indicator status-offline" id="status-indicator"></span>
                        Status: <span id="status-text">Connecting...</span>
                    </div>
                    <div class="text-xs text-gray-500" id="status-timestamp">--</div>
                    <div class="text-xs text-green-400" id="websocket-status">WebSocket: Disconnected</div>
                </div>
            </div>
        </header>

        <div class="mb-6 border-b border-gray-700">
            <nav class="flex space-x-8">
                <button onclick="switchTab('security')" id="tab-security" class="tab-button pb-4 px-1 border-b-2 border-blue-500 font-medium text-blue-400">
                    Security Scans
                </button>
                <button onclick="switchTab('pentest')" id="tab-pentest" class="tab-button pb-4 px-1 border-b-2 border-transparent font-medium text-gray-400 hover:text-red-400">
                    Penetration Testing
                </button>
                <button onclick="switchTab('behavioral')" id="tab-behavioral" class="tab-button pb-4 px-1 border-b-2 border-transparent font-medium text-gray-400 hover:text-gray-300">
                    Behavioral Analysis
                </button>
                <button onclick="switchTab('streams')" id="tab-streams" class="tab-button pb-4 px-1 border-b-2 border-transparent font-medium text-gray-400 hover:text-gray-300">
                    Camera Streams
                </button>
                <button onclick="switchTab('terminal')" id="tab-terminal" class="tab-button pb-4 px-1 border-b-2 border-transparent font-medium text-gray-400 hover:text-gray-300">
                    Terminal
                </button>
                <button onclick="switchTab('settings')" id="tab-settings" class="tab-button pb-4 px-1 border-b-2 border-transparent font-medium text-gray-400 hover:text-gray-300">
                    Configuration
                </button>
            </nav>
        </div>

        <div id="content-security" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <div class="lg:col-span-1 space-y-6">
                    
                    <section class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                        <h2 class="text-xl font-semibold mb-4 text-white flex items-center">
                            <svg class="w-5 h-5 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            Scan Control
                        </h2>
                        <form id="scan-form" onsubmit="handleScan(event)">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Target Type</label>
                                <select id="targetType" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                    <option value="file">File (YARA + Hash)</option>
                                    <option value="directory">Directory (Recursive)</option>
                                    <option value="network">Network/Port Scan</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Target Path / IP Range (CIDR/IP)</label>
                                <input type="text" id="target" required placeholder="/etc/passwd or 192.168.1.1/24" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            </div>
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Directory Depth (-1 = unlimited)</label>
                                <input type="number" id="depth" value="-1" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                Initiate Scan
                            </button>
                        </form>
                    </section>

                    <section class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                        <h2 class="text-xl font-semibold mb-4 text-white flex items-center">
                            <svg class="w-5 h-5 mr-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            System Actions
                        </h2>
                        <div class="space-y-3">
                            <button onclick="handleUpdate()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                                Update Definitions & Rules
                            </button>
                            <button onclick="handleStop()" class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                                Stop All Processes & Alarms
                            </button>
                        </div>
                    </section>
                </div>
                
                <div class="lg:col-span-2 space-y-6">

                    <section class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                        <h2 class="text-xl font-semibold mb-4 text-white flex items-center">
                            <svg class="w-5 h-5 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                            </svg>
                            Activity Log
                        </h2>
                        <div id="console-output" class="h-64 overflow-y-auto bg-gray-900 text-green-400 p-3 text-xs font-mono rounded-lg border border-gray-700">
                            [INIT] Connecting to Security Suite server...
                        </div>
                    </section>

                    <section class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                        <h2 class="text-xl font-semibold mb-4 text-white flex items-center">
                            <svg class="w-5 h-5 mr-2 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Scan Results
                        </h2>
                        <div id="scan-results" class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                            <p class="text-gray-400">No scan has been run yet. Results will appear here.</p>
                        </div>
                    </section>
                </div>
            </div>
        </div>
        
        <div id="content-pentest" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 space-y-6">
                    <section class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                        <h2 class="text-xl font-semibold mb-4 text-white flex items-center">
                            <svg class="w-5 h-5 mr-2 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0v4m-8 0h4m-4 0v4m4-4V7a4 4 0 10-8 0v4m0 0H4a2 2 0 00-2 2v5a2 2 0 002 2h16a2 2 0 002-2v-5a2 2 0 00-2-2h-4"></path>
                            </svg>
                            Exploit Execution
                        </h2>
                        <form id="pentest-form" onsubmit="handleExploitExecution(event)">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Target IP Address</label>
                                <input type="text" id="pentest-target" required placeholder="192.168.1.10" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:outline-none">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Exploit Name/CVE</label>
                                <select id="pentest-exploit" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:outline-none">
                                    <option value="CVE-2017-0144">CVE-2017-0144 (EternalBlue)</option>
                                    <option value="CVE-2019-0708">CVE-2019-0708 (BlueKeep)</option>
                                    <option value="SSH-Bruteforce">SSH Credential Brute-Force (Auth)</option>
                                    <option value="Web-SQLi">Web: SQL Injection Probe</option>
                                    </select>
                            </div>
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Credential/Password (Optional for Auth Exploits)</label>
                                <input type="password" id="pentest-password" placeholder="sudo password or target service password" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:outline-none">
                            </div>
                            <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                Launch Exploit
                            </button>
                        </form>
                    </section>
                </div>
                
                <div class="lg:col-span-2 space-y-6">
                    <section class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                        <h2 class="text-xl font-semibold mb-4 text-white flex items-center">
                            <svg class="w-5 h-5 mr-2 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2v2m0 0v2m-6-2a9 9 0 1118 0v5a2 2 0 01-2 2H4a2 2 0 01-2-2v-5a9 9 0 019-9z"></path>
                            </svg>
                            Exploit Log / Session Output
                        </h2>
                        <div id="pentest-log" class="h-64 overflow-y-auto bg-gray-900 text-red-400 p-3 text-xs font-mono rounded-lg border border-gray-700">
                            [READY] Penetration Testing module ready. Exploit results will stream here.
                        </div>
                    </section>
                </div>
            </div>
        </div>

        <div id="content-behavioral" class="tab-content hidden">
            <div class="grid grid-cols-1 gap-8">
                <section class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                    <h2 class="text-xl font-semibold mb-4 text-white flex items-center">
                        <svg class="w-5 h-5 mr-2 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        Behavioral Analysis Dashboard
                    </h2>
                    <div class="bg-gray-900 p-6 rounded-lg border border-gray-700">
                        <p class="text-gray-300 mb-4">
                            Real-time behavioral anomaly detection using Isolation Forest and Statistical Baseline analysis.
                        </p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-gray-800 p-4 rounded-lg border border-gray-600">
                                <div class="text-sm text-gray-400">Monitored Devices</div>
                                <div class="text-3xl font-bold text-blue-400" id="ba-devices">0</div>
                            </div>
                            <div class="bg-gray-800 p-4 rounded-lg border border-gray-600">
                                <div class="text-sm text-gray-400">Anomalies Detected</div>
                                <div class="text-3xl font-bold text-yellow-400" id="ba-anomalies">0</div>
                            </div>
                            <div class="bg-gray-800 p-4 rounded-lg border border-gray-600">
                                <div class="text-sm text-gray-400">Model Status</div>
                                <div class="text-sm font-semibold text-green-400" id="ba-model">Active (Last Train: <span id="ba-last-train">--</span>)</div>
                            </div>
                        </div>
                        <div class="text-sm text-gray-400 space-y-2">
                            <p>Current Anomaly Threshold: <span id="ba-threshold" class="text-white">0.65</span></p>
                            <button onclick="triggerTraining()" class="bg-green-600 hover:bg-green-700 text-white text-sm font-medium py-1 px-3 rounded transition duration-200">
                                Retrain Anomaly Model
                            </button>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <div id="content-streams" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1">
                    <section class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                        <h2 class="text-xl font-semibold mb-4 text-white flex items-center">
                            <svg class="w-5 h-5 mr-2 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                            Video Stream Control
                        </h2>
                        <div class="space-y-4">
                            <select id="stream-selector" onchange="selectStream(this.value)" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                                <option value="">--- Select Camera Stream ---</option>
                                <option value="cam-1">Camera 1 (Front Door)</option>
                                <option value="cam-2">Camera 2 (Data Center)</option>
                                <option value="cam-3">RTSP Stream Example</option>
                            </select>
                            <button onclick="startStreamMonitoring()" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                                Start Stream Analysis
                            </button>
                            <div id="stream-status" class="flex items-center justify-between mt-3 p-3 bg-gray-900 rounded-lg border border-gray-700 hidden">
                                <span class="text-sm text-gray-300">Analysis Status:</span>
                                <div class="flex items-center">
                                    <span class="w-3 h-3 pulse-green bg-green-500 rounded-full mr-2"></span>
                                    <span class="text-sm text-green-400">LIVE</span>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700 mt-6">
                        <h2 class="text-xl font-semibold mb-4 text-white">Detection Metrics</h2>
                        <div id="stream-info" class="p-4 bg-gray-900 rounded-lg border border-gray-700 hidden">
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div><span class="text-gray-400">Name:</span> <span class="text-white ml-2" id="info-name">--</span></div>
                                <div><span class="text-gray-400">Status:</span> <span class="text-white ml-2" id="info-status">--</span></div>
                                <div class="col-span-2"><span class="text-gray-400">URL:</span> <span class="text-white ml-2 break-all" id="info-url">--</span></div>
                                <div class="col-span-2"><span class="text-gray-400">Reason:</span> <span class="text-white ml-2" id="info-reason">--</span></div>
                            </div>
                        </div>
                        <p class="text-gray-500 text-sm">Real-time object detection and anomaly tracking metrics will appear here.</p>
                    </section>
                </div>
                
                <div class="lg:col-span-2">
                    <section class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                        <h2 class="text-xl font-semibold mb-4 text-white">Live Feed</h2>
                        <div id="stream-viewer" class="stream-container rounded-lg overflow-hidden border border-gray-700 bg-gray-900 min-h-[400px] flex items-center justify-center">
                            <div class="text-center text-gray-500">
                                <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                <p>Select a stream to begin viewing.</p>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>

        <div id="content-terminal" class="tab-content hidden">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-white flex items-center">
                        <svg class="w-5 h-5 mr-2 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h.01M17 19h2a2 2 0 002-2V7a2 2 0 00-2-2h-5l-3 3h-5a2 2 0 00-2 2v5m0 0a2 2 0 002 2h16a2 2 0 002-2v-5a2 2 0 00-2-2h-3l-3-3h-5a2 2 0 00-2 2v5z"></path>
                        </svg>
                        Interactive PTY Shell
                        <span id="terminal-session-id" class="text-xs ml-3 text-gray-500">Session ID: --</span>
                    </h2>
                    <div class="space-x-3">
                        <button onclick="createTerminalSession()" id="btn-terminal-connect" class="bg-green-600 hover:bg-green-700 text-white font-medium py-1 px-3 rounded transition duration-200">
                            Connect/New Session
                        </button>
                        <button onclick="closeTerminalSession()" id="btn-terminal-disconnect" disabled class="bg-red-600 hover:bg-red-700 text-white font-medium py-1 px-3 rounded transition duration-200 disabled:opacity-50">
                            Disconnect
                        </button>
                    </div>
                </div>

                <div id="terminal-output" class="terminal-output h-80 overflow-y-auto p-3 rounded-lg border border-green-700">
                    [INFO] Click 'Connect/New Session' to start an interactive PTY shell.
                </div>
                
                <div class="flex mt-4 space-x-3">
                    <input type="text" id="terminal-input" placeholder="Type command and press Enter..." disabled class="terminal-input flex-grow bg-gray-900 text-white px-4 py-2 focus:ring-2 focus:ring-green-500 focus:outline-none disabled:opacity-50">
                </div>

                <div class="mt-4 pt-4 border-t border-gray-700">
                    <p class="text-sm font-medium text-gray-300 mb-3">Quick Commands (requires active terminal):</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <button onclick="quickCommand('sudo ./security_suite -mode web')" class="text-left text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 px-3 py-2 rounded transition"> Start Web Mode (sudo) </button>
                        <button onclick="quickCommand('sudo iptables -L -n')" class="text-left text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 px-3 py-2 rounded transition"> List iptables Rules </button>
                        <button onclick="quickCommand('sudo systemctl status security_suite')" class="text-left text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 px-3 py-2 rounded transition"> System Status </button>
                        <button onclick="quickCommand('ps aux | grep security')" class="text-left text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 px-3 py-2 rounded transition"> Check Processes </button>
                    </div>
                </div>
                
                <div class="mt-4 pt-4 border-t border-gray-700">
                    <p class="text-sm font-medium text-gray-300 mb-2">Resize Terminal:</p>
                    <div class="flex items-center space-x-3">
                        <input type="number" id="resize-cols" value="80" placeholder="Cols" class="w-20 bg-gray-700 text-white border border-gray-600 rounded-lg px-2 py-1 text-sm">
                        <span class="text-gray-400">x</span>
                        <input type="number" id="resize-rows" value="24" placeholder="Rows" class="w-20 bg-gray-700 text-white border border-gray-600 rounded-lg px-2 py-1 text-sm">
                        <button onclick="resizeTerminal()" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium py-1 px-3 rounded transition duration-200">
                            Resize
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-settings" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                <div class="space-y-6">
                    <section class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                        <h2 class="text-xl font-semibold mb-4 text-white flex items-center">
                            <svg class="w-5 h-5 mr-2 text-teal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.562.343 1.24-.037 1.942-.515z"></path>
                            </svg>
                            Core Application Settings
                        </h2>
                        <form id="core-settings-form">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Web Server Port</label>
                                    <input type="number" id="setting-server-port" value="8080" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-3 py-2 text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Event Stream Max Clients</label>
                                    <input type="number" id="setting-max-clients" value="10" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-3 py-2 text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Session Inactivity Timeout (minutes)</label>
                                    <input type="number" id="setting-session-timeout" value="30" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-3 py-2 text-sm">
                                </div>
                                <div class="flex items-center">
                                    <input id="setting-verbose-logging" type="checkbox" checked class="h-4 w-4 text-teal-600 bg-gray-700 border-gray-600 rounded">
                                    <label for="setting-verbose-logging" class="ml-3 text-sm text-gray-300">Enable Verbose Logging</label>
                                </div>
                            </div>
                        </form>
                    </section>
                    
                    <section class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                        <h2 class="text-xl font-semibold mb-4 text-white flex items-center">
                            <svg class="w-5 h-5 mr-2 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2v2m0 0v2m-6-2a9 9 0 1118 0v5a2 2 0 01-2 2H4a2 2 0 01-2-2v-5a9 9 0 019-9z"></path>
                            </svg>
                            Behavioral Analysis Tuning
                        </h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Anomaly Threshold (0.0 to 1.0)</label>
                                <input type="number" step="0.01" id="setting-anomaly-threshold" value="0.65" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-3 py-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Retrain Interval (hours)</label>
                                <input type="number" id="setting-retrain-interval" value="24" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-3 py-2 text-sm">
                            </div>
                        </div>
                    </section>
                </div>

                <div class="space-y-6">
                    <section class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                        <h2 class="text-xl font-semibold mb-4 text-white flex items-center">
                            <svg class="w-5 h-5 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            Network Scanner Settings
                        </h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Scan Profile</label>
                                <select id="setting-scan-profile" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-3 py-2 text-sm">
                                    <option value="quick">Quick (Common Ports, No Vuln Scan)</option>
                                    <option value="standard">Standard (1k Ports, Service Detection)</option>
                                    <option value="comprehensive">Comprehensive (Full Ports, OS/Service/Vuln)</option>
                                    <option value="pentest">PenTest (Aggressive, Full Discovery)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Max Host Concurrency</label>
                                <input type="number" id="setting-max-concurrency" value="100" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-3 py-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Probe Timeout (seconds)</label>
                                <input type="number" id="setting-probe-timeout" value="5" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-3 py-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Host Discovery Method</label>
                                <select id="setting-discovery-method" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-3 py-2 text-sm">
                                    <option value="tcp">TCP/SYN Probe</option>
                                    <option value="noprobe">ARP/ICMP (No-Probe)</option>
                                </select>
                            </div>
                        </div>
                    </section>

                    <button onclick="saveConfiguration()" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                        </svg>
                        Save All Configuration
                    </button>
                    
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Production Global Variables
        let terminalSessionID = null;
        let terminalWebSocket = null;
        let eventWebSocket = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        // ===== Helper Functions =====
        function getWsURL(path) {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            return `${wsProtocol}//${window.location.host}${path}`;
        }
        
        function getApiURL(path) {
            return `http://${window.location.host}/api${path}`;
        }

        // Logs messages to the Activity Log and console
        function logToConsole(message, level = 'INFO') {
            const now = new Date().toLocaleTimeString();
            const consoleOutput = document.getElementById('console-output');
            let color = 'text-green-400';
            
            if (level === 'ERROR') { color = 'text-red-400'; }
            if (level === 'WARN') { color = 'text-yellow-400'; }
            if (level === 'SUCCESS') { color = 'text-blue-400'; }
            
            const logEntry = `<div class="${color}">[${now}] [${level}] ${message}</div>`;
            consoleOutput.innerHTML += logEntry;
            consoleOutput.scrollTop = consoleOutput.scrollHeight; // Auto-scroll
        }
        
        function appendTerminalOutput(data) {
            const outputElement = document.getElementById('terminal-output');
            outputElement.innerHTML += data;
            outputElement.scrollTop = outputElement.scrollHeight; // Auto-scroll
        }

        // ===== System Status & Events =====
        function checkStatus() {
            // Placeholder for API call to check server health
            fetch(getApiURL('/status'))
                .then(response => {
                    if (response.ok) {
                        document.getElementById('status-indicator').className = 'status-indicator status-online';
                        document.getElementById('status-text').textContent = 'Online';
                        document.getElementById('status-timestamp').textContent = `Last check: ${new Date().toLocaleTimeString()}`;
                    } else {
                        throw new Error('Server offline');
                    }
                })
                .catch(error => {
                    document.getElementById('status-indicator').className = 'status-indicator status-offline';
                    document.getElementById('status-text').textContent = 'Offline';
                    document.getElementById('status-timestamp').textContent = `Last check: ${new Date().toLocaleTimeString()}`;
                    logToConsole(`Server status check failed: ${error.message}`, 'ERROR');
                });
        }
        
        function connectEventWebSocket() {
            if (eventWebSocket) { eventWebSocket.close(); }
            
            const wsURL = getWsURL('/api/events');
            eventWebSocket = new WebSocket(wsURL);

            eventWebSocket.onopen = () => {
                logToConsole('Event stream connected', 'SUCCESS');
                document.getElementById('websocket-status').textContent = 'WebSocket: Connected';
                document.getElementById('websocket-status').className = 'text-xs text-green-400';
                reconnectAttempts = 0;
            };

            eventWebSocket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleEventMessage(data);
                } catch (error) {
                    logToConsole(`Event parse error: ${error.message}`, 'ERROR');
                }
            };

            eventWebSocket.onerror = (error) => {
                logToConsole('Event stream error', 'ERROR');
                document.getElementById('websocket-status').textContent = 'WebSocket: Error';
                document.getElementById('websocket-status').className = 'text-xs text-red-400';
            };

            eventWebSocket.onclose = () => {
                logToConsole('Event stream disconnected', 'WARN');
                document.getElementById('websocket-status').textContent = 'WebSocket: Disconnected';
                document.getElementById('websocket-status').className = 'text-xs text-yellow-400';
                
                // Attempt reconnection
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000); // Exponential backoff
                    logToConsole(`Reconnecting event stream in ${delay/1000}s (attempt ${reconnectAttempts}/${maxReconnectAttempts})...`, 'WARN');
                    setTimeout(connectEventWebSocket, delay);
                } else {
                    logToConsole('Max reconnection attempts reached. Check server status.', 'CRITICAL');
                }
            };
        }

        function handleEventMessage(data) {
            switch (data.type) {
                case 'scan_complete':
                    logToConsole('Scan completed', 'SUCCESS');
                    if (data.status === 'success') {
                        renderScanResults(data.data);
                    } else {
                        logToConsole(`Scan error: ${data.message}`, 'ERROR');
                    }
                    break;
                case 'threat_detected':
                    logToConsole(`[${data.severity.toUpperCase()}] Threat detected: ${data.signature} on ${data.target}`, 'CRITICAL');
                    // Add logic to update a global threat counter or notification bell
                    break;
                case 'behavioral_anomaly':
                    logToConsole(`Behavioral anomaly detected: ${data.context} on ${data.source_ip}`, 'WARN');
                    // Update Behavioral Analysis Dashboard metrics
                    document.getElementById('ba-anomalies').textContent = data.total_anomalies_today;
                    break;
                case 'terminal_output':
                    // Check if the terminal tab is active or if the session ID matches the exploit log
                    const pentestLog = document.getElementById('pentest-log');
                    const terminalTab = document.getElementById('content-terminal');
                    
                    if (data.session_id === terminalSessionID && !terminalTab.classList.contains('hidden')) {
                         appendTerminalOutput(data.output);
                    } else if (data.exploit_session) {
                        // Stream exploit output to pentest log
                        pentestLog.innerHTML += data.output;
                        pentestLog.scrollTop = pentestLog.scrollHeight;
                    }
                    break;
                case 'config_update':
                    // Notification that configuration was successfully applied on the server
                    logToConsole('Server configuration updated successfully.', 'SUCCESS');
                    break;
                default:
                    logToConsole(`Received unknown event type: ${data.type}`, 'INFO');
            }
        }
        
        // Function to render scan results (kept brief for brevity)
        function renderScanResults(data) {
            let severityClass = 'bg-green-900/30 border-green-700';
            if (data.threats && data.threats.length > 0) {
                severityClass = 'bg-red-900/30 border-red-700';
            }
            
            const resultsHtml = `
                <div class="grid grid-cols-4 gap-4 text-center text-sm mb-4">
                    <div class="p-3 bg-gray-900/30 rounded-lg border border-gray-700">
                        <div class="text-2xl font-bold text-white">${data.total_files_scanned || data.total_hosts_scanned || 0}</div>
                        <div class="text-xs text-gray-400">Total Scanned</div>
                    </div>
                    <div class="p-3 bg-blue-900/30 rounded-lg border border-blue-700">
                        <div class="text-2xl font-bold text-blue-400">${data.ports_open || 0}</div>
                        <div class="text-xs text-gray-400">Open Ports</div>
                    </div>
                    <div class="p-3 bg-yellow-900/30 rounded-lg border border-yellow-700">
                        <div class="text-2xl font-bold text-yellow-400">${data.total_files_scanned_with_findings || data.total_vulnerabilities || 0}</div>
                        <div class="text-xs text-gray-400">Total Findings</div>
                    </div>
                    <div class="p-3 ${severityClass} rounded-lg border">
                        <div class="text-2xl font-bold ${data.threats && data.threats.length > 0 ? 'text-red-400' : 'text-green-400'}">${data.threats ? data.threats.length : 0}</div>
                        <div class="text-xs text-gray-400">Threats</div>
                    </div>
                </div>
                ${(data.threats && data.threats.length > 0) ? `
                    <h3 class="text-lg font-semibold mt-4 mb-3 text-white">Threat Details:</h3>
                    <div class="space-y-2 max-h-80 overflow-y-auto">
                        ${data.threats.map(threat => {
                            let severityClass = 'bg-gray-700 border-gray-600';
                            let severityColor = 'text-gray-300';
                            if (threat.severity) {
                                const sev = threat.severity.toString().toUpperCase();
                                if (sev === 'CRITICAL') { severityClass = 'bg-red-900/30 border-red-700'; severityColor = 'text-red-400'; } 
                                else if (sev === 'HIGH') { severityClass = 'bg-orange-900/30 border-orange-700'; severityColor = 'text-orange-400'; }
                                else if (sev === 'MEDIUM') { severityClass = 'bg-yellow-900/30 border-yellow-700'; severityColor = 'text-yellow-400'; }
                            }
                            return `<div class="${severityClass} p-3 rounded-lg border flex justify-between items-center">
                                <span class="font-mono text-xs ${severityColor}">${threat.signature}</span>
                                <span class="text-sm text-white">${threat.target}</span>
                            </div>`;
                        }).join('')}
                    </div>
                ` : `<p class="text-green-400 font-semibold mt-3">Scan completed. No major threats detected.</p>`}
            `;
            document.getElementById('scan-results').innerHTML = resultsHtml;
        }


        // ===== Security Scan Handlers =====
        function handleScan(event) {
            event.preventDefault();
            const targetType = document.getElementById('targetType').value;
            const target = document.getElementById('target').value;
            const depth = document.getElementById('depth').value;

            logToConsole(`Initiating ${targetType.toUpperCase()} scan on ${target}...`, 'INFO');
            
            fetch(getApiURL('/scan'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ target_type: targetType, target: target, depth: parseInt(depth) })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'started') {
                    logToConsole(`Scan initiated. Results will be streamed via WebSocket.`, 'SUCCESS');
                    document.getElementById('scan-results').innerHTML = `<p class="text-gray-400">Scan Job ID ${data.job_id} started. Awaiting results...</p>`;
                } else {
                    logToConsole(`Scan initiation failed: ${data.message}`, 'ERROR');
                }
            })
            .catch(error => logToConsole(`Network error submitting scan: ${error.message}`, 'ERROR'));
        }

        function handleUpdate() {
            logToConsole('Requesting rule and definition updates...', 'INFO');
            fetch(getApiURL('/update'), { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                logToConsole(data.message, data.status === 'success' ? 'SUCCESS' : 'ERROR');
            })
            .catch(error => logToConsole(`Network error requesting update: ${error.message}`, 'ERROR'));
        }

        function handleStop() {
            if (!confirm("CRITICAL: Are you sure you want to stop all active security processes?")) return;
            logToConsole('Sending critical stop command to all running processes...', 'CRITICAL');
            fetch(getApiURL('/stop'), { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                logToConsole(data.message, data.status === 'success' ? 'SUCCESS' : 'ERROR');
            })
            .catch(error => logToConsole(`Network error sending stop command: ${error.message}`, 'ERROR'));
        }

        // ===== Penetration Testing Handlers (NEW) =====
        function handleExploitExecution(event) {
            event.preventDefault();
            const targetIP = document.getElementById('pentest-target').value;
            const exploitID = document.getElementById('pentest-exploit').value;
            const password = document.getElementById('pentest-password').value;

            if (!targetIP || !exploitID) {
                logToConsole("Target IP and Exploit must be selected.", 'WARN');
                return;
            }

            logToConsole(`Launching Exploit: ${exploitID} against ${targetIP}...`, 'CRITICAL');
            document.getElementById('pentest-log').innerHTML = `<div class="text-red-400">[ATTACK] Connecting and executing payload...</div>`;

            fetch(getApiURL('/pentest/execute'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    target_ip: targetIP, 
                    exploit_id: exploitID, 
                    password: password 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'session_created') {
                    logToConsole(`Exploit session created (ID: ${data.session_id}). Output will stream to the PenTest Log.`, 'SUCCESS');
                    document.getElementById('pentest-log').innerHTML += `<div class="text-yellow-400">[SESSION] Exploit session opened. Awaiting output...</div>`;
                } else {
                    logToConsole(`Exploit failed to launch: ${data.message}`, 'ERROR');
                }
            })
            .catch(error => logToConsole(`Network error during exploit launch: ${error.message}`, 'ERROR'));
        }


        // ===== Terminal Handlers (ENHANCED) =====
        function createTerminalSession() {
            // Check if active session exists
            if (terminalSessionID) {
                logToConsole(`Session ${terminalSessionID} already active. Disconnect first.`, 'WARN');
                return;
            }

            logToConsole('Requesting new terminal session...', 'INFO');
            
            fetch(getApiURL('/terminal/create'), { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.session_id) {
                    terminalSessionID = data.session_id;
                    document.getElementById('terminal-session-id').textContent = `Session ID: ${terminalSessionID}`;
                    document.getElementById('terminal-output').innerHTML = '<div class="text-green-400">Terminal session started. Type commands below or use the input field.</div>\n';

                    document.getElementById('btn-terminal-connect').disabled = true;
                    document.getElementById('btn-terminal-disconnect').disabled = false;
                    document.getElementById('terminal-input').disabled = false;
                    document.getElementById('terminal-input').focus();
                    
                    connectTerminalWebSocket();
                    logToConsole(`Terminal session created: ${terminalSessionID}`, 'SUCCESS');
                } else {
                    throw new Error(data.message || 'Unknown response from server');
                }
            })
            .catch(error => {
                logToConsole(`Failed to create terminal: ${error.message}`, 'ERROR');
                alert('Failed to create terminal session. Check server logs.');
            });
        }
        
        function closeTerminalSession() {
             if (!terminalSessionID) return;

             logToConsole(`Requesting closure of session: ${terminalSessionID}`, 'INFO');

             fetch(getApiURL('/terminal/close'), {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify({ session_id: terminalSessionID })
             })
             .then(response => response.json())
             .then(data => {
                 logToConsole(data.message, data.status === 'closed' ? 'SUCCESS' : 'ERROR');
                 cleanupTerminal();
             })
             .catch(error => {
                 logToConsole(`Network error closing session: ${error.message}`, 'ERROR');
                 cleanupTerminal(); // Force cleanup client-side even on error
             });
        }
        
        function cleanupTerminal() {
            if (terminalWebSocket) {
                terminalWebSocket.close(); // Close the WebSocket
                terminalWebSocket = null;
            }
            terminalSessionID = null;
            document.getElementById('terminal-session-id').textContent = 'Session ID: --';
            document.getElementById('terminal-output').innerHTML += '\n<div class="text-red-400">Session terminated.</div>';
            document.getElementById('btn-terminal-connect').disabled = false;
            document.getElementById('btn-terminal-disconnect').disabled = true;
            document.getElementById('terminal-input').disabled = true;
            document.getElementById('terminal-input').value = '';
        }

        function connectTerminalWebSocket() {
            if (terminalWebSocket) { terminalWebSocket.close(); } 
            
            const wsURL = getWsURL(`/terminal/ws?session_id=${terminalSessionID}`);
            logToConsole('Connecting terminal WebSocket...', 'INFO');

            terminalWebSocket = new WebSocket(wsURL);
            
            terminalWebSocket.onopen = () => {
                logToConsole('Terminal WebSocket connected', 'SUCCESS');
            };
            
            terminalWebSocket.onmessage = (event) => {
                appendTerminalOutput(event.data);
            };
            
            terminalWebSocket.onerror = (error) => {
                logToConsole('Terminal stream error.', 'ERROR');
                cleanupTerminal();
            };
            
            terminalWebSocket.onclose = () => {
                if (terminalSessionID) {
                    logToConsole('Terminal stream closed by server. Session likely ended.', 'WARN');
                    // Note: cleanupTerminal will be called by closeTerminalSession's promise chain.
                }
            };
        }
        
        function sendTerminalInput() {
            const inputElement = document.getElementById('terminal-input');
            const command = inputElement.value + '\n'; // Add newline to execute command
            
            if (!terminalWebSocket || terminalWebSocket.readyState !== WebSocket.OPEN) {
                logToConsole('Terminal is not connected.', 'ERROR');
                return;
            }
            
            // Log the command locally for immediate feedback
            appendTerminalOutput(`\n$ ${inputElement.value}\n`);
            
            // Send the command via the WebSocket
            terminalWebSocket.send(command);
            
            // Clear input field
            inputElement.value = '';
        }
        
        // Key listener for the terminal input box
        document.getElementById('terminal-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Prevent adding a newline in the input field
                sendTerminalInput();
            }
        });

        function quickCommand(command) {
            if (!terminalSessionID) {
                logToConsole("Please connect to a terminal session first.", 'WARN');
                return;
            }
            document.getElementById('terminal-input').value = command;
            sendTerminalInput();
        }

        function resizeTerminal() {
            const rows = document.getElementById('resize-rows').value;
            const cols = document.getElementById('resize-cols').value;

            if (!terminalSessionID || !rows || !cols) {
                logToConsole("Invalid session or size parameters.", 'WARN');
                return;
            }

            fetch(getApiURL('/terminal/resize'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_id: terminalSessionID, rows: parseInt(rows), cols: parseInt(cols) })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'resized') {
                    logToConsole(`Terminal resized to ${cols}x${rows}`, 'INFO');
                } else {
                    logToConsole(`Resize failed: ${data.message}`, 'ERROR');
                }
            })
            .catch(error => logToConsole(`Network error during resize: ${error.message}`, 'ERROR'));
        }

        // ===== Stream Handlers (Brief) =====
        function selectStream(streamId) {
            const viewer = document.getElementById('stream-viewer');
            const infoBox = document.getElementById('stream-info');
            
            if (streamId === 'cam-1') {
                viewer.innerHTML = `<img src="http://localhost:8080/stream/cam1" alt="Live Stream" class="w-full h-auto" onerror="handleStreamError()">`;
                infoBox.classList.remove('hidden');
                document.getElementById('info-name').textContent = 'Camera 1 (Front)';
                document.getElementById('info-url').textContent = 'http://localhost:8080/stream/cam1 (MJPEG)';
                document.getElementById('info-status').textContent = 'Live';
                document.getElementById('info-reason').textContent = 'Direct MJPEG feed.';
            } else if (streamId === 'cam-2') {
                viewer.innerHTML = `<img src="http://localhost:8080/stream/cam2" alt="Live Stream" class="w-full h-auto" onerror="handleStreamError()">`;
                infoBox.classList.remove('hidden');
                document.getElementById('info-name').textContent = 'Camera 2 (Data Center)';
                document.getElementById('info-url').textContent = 'http://localhost:8080/stream/cam2 (MJPEG)';
                document.getElementById('info-status').textContent = 'Live';
                document.getElementById('info-reason').textContent = 'Direct MJPEG feed.';
            } else if (streamId === 'cam-3') {
                // RTSP requires client-side media player, inform the user
                viewer.innerHTML = `
                    <div class="text-center text-white p-8">
                        <svg class="w-16 h-16 mx-auto mb-4 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <h3 class="text-xl font-semibold mb-2">RTSP Stream Detected</h3>
                        <p class="text-gray-400 mb-4">RTSP streams require a compatible media player (e.g., VLC) for direct playback.</p>
                        <div class="bg-gray-900 p-4 rounded-lg text-left border border-gray-700">
                            <p class="text-sm text-gray-300 mb-2">Stream URL:</p>
                            <code class="text-xs text-cyan-400 break-all">rtsp://user:pass@192.168.1.50/live/ch0</code>
                        </div>
                    </div>
                `;
                infoBox.classList.remove('hidden');
                document.getElementById('info-name').textContent = 'Camera 3 (RTSP)';
                document.getElementById('info-url').textContent = 'rtsp://user:pass@192.168.1.50/live/ch0 (RTSP)';
                document.getElementById('info-status').textContent = 'Monitored';
                document.getElementById('info-reason').textContent = 'RTSP link provided for external viewer.';
            } else {
                viewer.innerHTML = `<div class="text-center text-gray-500"><svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg><p>Select a stream to begin viewing.</p></div>`;
                infoBox.classList.add('hidden');
            }
        }
        function startStreamMonitoring() {
            logToConsole("Video analysis started for selected stream...", 'SUCCESS');
        }
        function handleStreamError() {
            document.getElementById('stream-viewer').innerHTML = `<div class="text-center text-red-500 p-8">Stream connection failed or URL is invalid.</div>`;
            logToConsole('Stream viewer error: Failed to load image/video source.', 'ERROR');
        }

        // ===== Configuration Handlers (NEW) =====
        function loadConfiguration() {
            // Simulated function to load current settings from backend
            logToConsole("Fetching current configuration from server...", 'INFO');
            
            // In a real scenario, this would fetch the current config from the server.
            // For now, we use the default values set in the HTML.
            
            // Simulate updating BA last training time
            document.getElementById('ba-last-train').textContent = new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString();
        }

        function saveConfiguration() {
            const config = {
                core: {
                    server_port: parseInt(document.getElementById('setting-server-port').value),
                    max_clients: parseInt(document.getElementById('setting-max-clients').value),
                    session_timeout_min: parseInt(document.getElementById('setting-session-timeout').value),
                    verbose_logging: document.getElementById('setting-verbose-logging').checked
                },
                behavioral: {
                    anomaly_threshold: parseFloat(document.getElementById('setting-anomaly-threshold').value),
                    retrain_interval_hours: parseInt(document.getElementById('setting-retrain-interval').value)
                },
                network: {
                    scan_profile: document.getElementById('setting-scan-profile').value,
                    max_concurrency: parseInt(document.getElementById('setting-max-concurrency').value),
                    probe_timeout_sec: parseInt(document.getElementById('setting-probe-timeout').value),
                    discovery_method: document.getElementById('setting-discovery-method').value
                }
            };
            
            logToConsole('Saving and applying new configuration...', 'INFO');
            
            fetch(getApiURL('/update'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    logToConsole('Configuration saved successfully. Server applying changes.', 'SUCCESS');
                } else {
                    logToConsole(`Configuration save failed: ${data.message}`, 'ERROR');
                }
            })
            .catch(error => logToConsole(`Network error saving config: ${error.message}`, 'ERROR'));
        }

        // ===== Tab Switching =====
        function switchTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => {
                el.classList.remove('border-blue-500', 'text-blue-400', 'border-red-500', 'text-red-400', 'border-teal-500', 'text-teal-400');
                el.classList.add('border-transparent', 'text-gray-400');
            });
            
            // Show selected tab
            document.getElementById('content-' + tab).classList.remove('hidden');
            const button = document.getElementById('tab-' + tab);

            if (tab === 'pentest') {
                button.classList.remove('border-transparent', 'text-gray-400');
                button.classList.add('border-red-500', 'text-red-400');
            } else if (tab === 'settings') {
                button.classList.remove('border-transparent', 'text-gray-400');
                button.classList.add('border-teal-500', 'text-teal-400');
                loadConfiguration(); // Load settings when the tab is opened
            } else {
                button.classList.remove('border-transparent', 'text-gray-400');
                button.classList.add('border-blue-500', 'text-blue-400');
            }
        }

        // ===== Initialization =====
        window.onload = () => {
            logToConsole('Security Suite initialized', 'SUCCESS');
            checkStatus();
            connectEventWebSocket();
            
            // Auto-refresh status every 30 seconds
            setInterval(checkStatus, 30000);

            // Set initial tab
            switchTab('security');
        };

        // Handle page unload to close WebSockets
        window.onbeforeunload = () => {
            if (terminalWebSocket) { terminalWebSocket.close(); }
            if (eventWebSocket) { eventWebSocket.close(); }
        };
    </script>
</body>
</html>